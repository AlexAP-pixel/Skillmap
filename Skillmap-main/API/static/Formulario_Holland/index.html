<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="http://127.0.0.1:8000/static/Logo.ico">
    <title>Test</title>
    <link rel="stylesheet" href="http://127.0.0.1:8000/static/Formulario_Holland/styles.css">
    <style>
      body{display: block;}
      header{opacity: 0;}
    </style>
</head>
<body>
  <header>
    <img class="logoimg" src="http://127.0.0.1:8000/static/Login/Logo.png">
    <span class="logo">Skillmap</span>
    <nav>
        <div id="navbar">
            <a href="http://127.0.0.1:8000/Skillmap/Inicio">Inicio</a>
            <a href="http://127.0.0.1:8000/Skillmap/Dashboard">Mi cuenta</a>
            <a href="http://127.0.0.1:8000/Skillmap/AboutUs">Acerca de</a>
            <a href="http://127.0.0.1:8000/Skillmap/Contacto">Contacto</a>
            <a href="#" id="cerrar_sesion">Cerrar sesión</a>
        </div>
    </nav>
  </header>
  <br>
  <div class="centered-container">
    <div class="form-container">
        <form id="vocational-form">
            <h1>Test De Orientación Vocacional Holland</h1>
            <div class="questions-container" id="questions-container">
            </div>
            <div class="custom-popup" id="customPopup" style="color: white">
              <span class="popup-message" id="popupMessage"></span>
            </div>  
        </form>
        <div class="button-container" id="buttonContainer">
          <button type="button" id="enviarRespuestasPRE" style="opacity: 0;"></button> 
          <button type="button" id="enviarRespuestas">Enviar Respuestas</button>    
          <button type="button" id="enviarRespuestasPOS" style="opacity: 0;"></button>   
          <button type="button" id="anterior" class="hidden">Anterior</button>
          <button type="button" id="regresar" class="hidden">Regresar a seleccion</button>
          <button type="button" id="siguiente" class="hidden">Siguiente</button>
        </div>
    </div>
  </div>
  <br><br><br><br><br><br><br><br><br>
  <footer>
    <p>
        </i> <a href="mailto:skillmap2024@gmail.com"> skillmap2024@outlook.com</a><span style="margin-right: 100px;"></span>
        </i> <a href="tel:5611670871"> 5611670871</a>
        
    </p>
    <p>&copy; 2023 Skillmap. Todos los derechos reservados</p>
  </footer>
</body>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    await cargarPreguntas();
    mostrarPagina(0);
  });

  const preguntasPorPagina =45;
  let paginaActual = 0;
  const totalPaginas = 4;

  async function cargarPreguntas() {
    try {
        const response = await fetch('http://127.0.0.1:8000/answersH/preguntas', {
            method: 'GET'
        });

        const data = await response.json(); 
        
        const questionsContainer = document.getElementById('questions-container');
        questionsContainer.innerHTML = '';
        let preguntas;
        let numPregunta;
        let numRespuesta = 97;
        preguntas = Object.keys(data).filter(key => key.startsWith('ques')).map((key, index) => {
          let commonHTML
          if(index === 0) {
            commonHTML = `
                <div class="options-group">
                    <label style = "color: black">Marque todos los adjetivos que describan su personalidad. Señale tantos como desee.</label><br>
                    <label style = "color: black">Trate de definirse tal como es, no como le gustaría ser.</label>
                    <br><br>
                    <input type="checkbox" name="res${index+1}" value="true">
                    <label>${data[key]}</label>
                </div>
            `;
          }else if(index < 45) {
            commonHTML = `
                <div class="options-group">
                    <input type="checkbox" name="res${index+1}" value="true">
                    <label>${data[key]}</label>
                </div>
            `;
          } else if(index < 63) {
            if (index === 45) {
              commonHTML = `
                <div>
                  <label style = "color: black">Califíquese de acuerdo con las siguientes características tal como considera ser en comparación con otras personas de su edad.</label><br>
                  <label style = "color: black">Seleccione la respuesta que más se ajuste a sí mismo.</label><br><br>
                </div>
                <div class='questions-options'>
                  <div class='questions'>
                      <label>${data[key]}</label>
                  </div>
                  <div class="options-group">
                    <input type="radio" name="res${index+1}" value="a">
                    <label for="res${index+1}">Más que los demás </label>
                    <input type="radio" name="res${index+1}" value="b">
                    <label for="res${index+1}">Igual que los demás</label>
                    <input type="radio" name="res${index+1}" value="c">
                    <label for="res${index+1}">Menos que los demás</label>
                  </div>
                </div>
              `;
            } else {
              commonHTML = `
                <div class='questions-options'>
                  <div class='questions'>
                      <label>${data[key]}</label>
                  </div>
                  <div class="options-group">
                    <input type="radio" name="res${index+1}" value="a">
                    <label for="res${index+1}">Más que los demás </label>
                    <input type="radio" name="res${index+1}" value="b">
                    <label for="res${index+1}">Igual que los demás</label>
                    <input type="radio" name="res${index+1}" value="c">
                    <label for="res${index+1}">Menos que los demás</label>
                  </div>
                </div>
              `;
            }
          }else if(index < 81) {
            if (index === 63) {
              commonHTML = `
                <div>
                  <label>Indique qué importancia da a las siguientes clases de logros, aspiraciones y metas.</label><br><br>
                </div>
                <div class='questions-options'>
                  <div class='questions'>
                      <label>${data[key]}</label>
                  </div>
                  <div class="options-group">
                    <input type="radio" name="res${index+1}" value="a">
                    <label for="res${index+1}">Más que los demás </label>
                    <input type="radio" name="res${index+1}" value="b">
                    <label for="res${index+1}">Igual que los demás</label>
                    <input type="radio" name="res${index+1}" value="c">
                    <label for="res${index+1}">Menos que los demás</label>
                  </div>
                </div>
              `;
            } else {
              commonHTML = `
                <div class='questions-options'>
                  <div class='questions'>
                      <label>${data[key]}</label>
                  </div>
                  <div class="options-group">
                    <input type="radio" name="res${index+1}" value="a">
                    <label for="res${index+1}">Más que los demás </label>
                    <input type="radio" name="res${index+1}" value="b">
                    <label for="res${index+1}">Igual que los demás</label>
                    <input type="radio" name="res${index+1}" value="c">
                    <label for="res${index+1}">Menos que los demás</label>
                  </div>
                </div>
              `;
            }
          } else {
            if (index === 81) {
              commonHTML = `
                <label style = "color: black">Para las siguientes preguntas escoja una sola alternativa, según lo que más se ajuste a usted.</label><br>
                <br><br>
                <label>${data[key]}</label>
              `;
              numPregunta = index + 1;
            } else {
              const val = (index + 3) % 7;
              if (val != 0){
                commonHTML = `
                <div class="options-group">
                    <br>
                    <input type="radio" name="res${numPregunta}" value="${String.fromCharCode(numRespuesta)}">
                    <label for="true">${data[key]}</label>
                </div>
                `;
                numRespuesta += 1;
              } else {
                commonHTML = `
                <br>
                <label>${data[key]}</label>
                `;
                numPregunta += 1;
                numRespuesta = 97;
              }
            }
          }
          return commonHTML;
        });
        window.preguntasTotales = preguntas;

        mostrarPagina(paginaActual);
    } catch (error) {
        console.error("Error cargando preguntas:", error);
    }
  }

  async function mostrarPagina(pagina) {
    cargarRespuestas();
    const questionsContainer = document.getElementById('questions-container');
    questionsContainer.innerHTML = '';

    let inicio, fin;

    if (pagina === 0) {
        inicio = 0;
        fin = 45;
    } else if (pagina === 1) {
        inicio = 45;
        fin = 63;
    } else if (pagina === 2) {
        inicio = 63;
        fin = 81;
    } else {
        inicio = 81;
        fin = window.preguntasTotales.length;
    }

    const preguntasPagina = window.preguntasTotales.slice(inicio, fin);
    questionsContainer.innerHTML = preguntasPagina.join('');

    agregarEventosGuardado();
    
    const botonEnviar = document.getElementById('enviarRespuestas');
    if (pagina === totalPaginas - 1) {
      botonEnviar.textContent = "Terminar Formulario";
      botonEnviar.onclick = enviarFormulario;
    } else {
      botonEnviar.textContent = "Siguiente Página";
      if (pagina === 0) {
        botonEnviar.onclick = () =>cambiarPagina(1);
      }else {
        botonEnviar.onclick = () => verificarRespuestasPaginaActual() &&  cambiarPagina(1);
      }
    }
    
  }

  function agregarEventosGuardado() {
    const form = document.getElementById("vocational-form");
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    const radioButtons = form.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(function(radioButton) {
      radioButton.addEventListener("change", function() {
        const pregunta = radioButton.getAttribute("name");
        const respuesta = radioButton.value;
        actualizarBaseDeDatos(pregunta, respuesta);
      });
    });
    checkboxes.forEach(function(checkBox) {
      checkBox.addEventListener("change", function() {
        const pregunta = checkBox.getAttribute("name");
        let respuesta = checkBox.value;
        if (!checkBox.checked){
          respuesta = "false";
        }
        actualizarBaseDeDatos(pregunta, respuesta);
      });
    });
  }

  function verificarRespuestasPaginaActual() {
    const form = document.getElementById("vocational-form");
    if (paginaActual + 1 === totalPaginas){
      const preguntaIds = ["res82", "res83", "res84", "res85", "res86"];
    
      for (const preguntaId of preguntaIds) {
          const radios = form.querySelectorAll(`input[name="${preguntaId}"]`);
          const algunaSeleccionada = [...radios].some(radio => radio.checked);
          if (!algunaSeleccionada) {
              showCustomPopup("Completa todas las preguntas antes de continuar", 2000, "#ec5353");
              return false;
          }
      }
      return true;
    }
    const radioGroups = form.querySelectorAll('.options-group');

    for (const group of radioGroups) {
      const radios = group.querySelectorAll('input[type="radio"]');
      const algunaSeleccionada = [...radios].some(radio => radio.checked);
      if (!algunaSeleccionada) {
        showCustomPopup("Completa todas las preguntas antes de continuar", 2000, "#ec5353");
        return false;
      }
    }
    return true;
  }

  function cambiarPagina(incremento) {
    paginaActual += incremento;

    if (paginaActual < 0) {
      paginaActual = 0;
    } else if (paginaActual >= totalPaginas) {
      paginaActual = totalPaginas - 1;
    }
    mostrarPagina(paginaActual);
  }

  async function enviarFormulario() {
    if (verificarRespuestasPaginaActual()) {
      let formLleno = true
      try {
        const response = await fetch(`http://127.0.0.1:8000/answersH?correo=${encodeURIComponent(data.correo)}`, {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
          }
        });
        const respuestasUsuario = await response.json();
        for (const [pregunta, respuesta] of Object.entries(respuestasUsuario)) {
          if (respuesta === " "){
            formLleno = false;
            break;
          }
        }
        if (!formLleno){
          showCustomPopup("Completa el formulario antes de continuar",2000,"#ec5353")
        }else{
          actualizarBaseDeDatos("formularioH", true)
          setTimeout(() => {
            window.location.href = 'http://127.0.0.1:8000/Skillmap/Empezar/Evaluaciones';
        }, 1000);
        }
      } catch (error) {
        console.error('Error al cargar respuestas:', error.message);
      }
    }
  }

  async function verificarAutenticacion() {
    const response = await fetch('http://127.0.0.1:8000/user/me', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
      }
    });
    window.data = await response.json();
    data = window.data
    if (!response.ok || data.error) {
      window.location.href = 'http://127.0.0.1:8000/Skillmap/';
    }else{
      document.querySelector('header').style.opacity = 1;
      verificarFormularioH();
      cargarRespuestas();
    }
  }
  async function cargarRespuestas() {
    try {
      const response = await fetch(`http://127.0.0.1:8000/answersH?correo=${encodeURIComponent(data.correo)}`, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        }
      });
      const respuestasUsuario = await response.json();
      for (const [pregunta, respuesta] of Object.entries(respuestasUsuario)) {
        const checkBox = document.querySelector(`input[name="${pregunta}"][value="${respuesta}"]`);
        if (checkBox) {
          checkBox.checked = true;
        }
      }
    } catch (error) {
      console.error('Error al cargar respuestas:', error.message);
    }
  }
  verificarAutenticacion();
  document.getElementById('cerrar_sesion').addEventListener('click', function() {
    localStorage.removeItem('access_token');
    window.location.href = 'http://127.0.0.1:8000/Skillmap/';
  });

  async function verificarFormularioH() {
    try {
      const response = await fetch(`http://127.0.0.1:8000/answersH?correo=${encodeURIComponent(data.correo)}`, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('access_token')
        }
      });
      const respuestasUsuario = await response.json();
      if (respuestasUsuario.formularioH === true) {
        const radioButtons = document.querySelectorAll('input[type="radio"]');
        const checkBoxes = document.querySelectorAll('input[type="checkbox"]');
        const botonAnterior = document.getElementById('anterior');
        const botonSiguiente = document.getElementById('siguiente');
        const botonRegresar = document.getElementById('regresar');
        const botonEnviar = document.getElementById('enviarRespuestas');
        const botonEnviarPre = document.getElementById('enviarRespuestasPRE');
        const botonEnviarPos = document.getElementById('enviarRespuestasPOS');
        checkBoxes.forEach(check => {
          check.disabled = true;
        });
        radioButtons.forEach(radioButton => {
          radioButton.disabled = true; 
        });
        botonEnviar.classList.add('hidden');
        botonEnviarPre.classList.add('hidden');
        botonEnviarPos.classList.add('hidden');
        botonAnterior.onclick = () => verificarFormularioH() && cambiarPagina(-1);
        botonSiguiente.onclick = () => verificarFormularioH() && cambiarPagina(1);
        botonRegresar.onclick = () => window.location.href = 'http://127.0.0.1:8000/Skillmap/Empezar/Evaluaciones'; 
        botonAnterior.classList.remove('hidden');        
        botonSiguiente.classList.remove('hidden');       
        botonRegresar.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Error al verificar formularioK:', error.message);
    }
  }

  async function actualizarBaseDeDatos(parametro, valor) {
    correo = (window.data).correo
    const response = await fetch(`http://127.0.0.1:8000/answersH?correo=${encodeURIComponent(correo)}&parametro=${parametro}&valor=${valor}`,{
      method: 'PATCH',
      headers: {
          'Content-Type': 'application/json',
      },
    });
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
  }

  function showCustomPopup(message, duration, backgroundColor) {
    const customPopup = document.getElementById('customPopup');
    const popupMessage = document.getElementById('popupMessage');

    customPopup.style.backgroundColor = backgroundColor;

    popupMessage.textContent = message;
    customPopup.style.display = 'block';

    customPopup.style.animation = 'slideDown 0.5s';

    setTimeout(() => {
        customPopup.style.animation = 'slideUp 0.5s';
        setTimeout(() => {
            customPopup.style.display = 'none';
            customPopup.style.animation = '';
        }, 500);
    }, duration);
  }
</script>
</html>